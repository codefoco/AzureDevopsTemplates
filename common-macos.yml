  steps:
  
  - script: '/usr/bin/xcodebuild -version'
    displayName: 'Show Xcode Version' 
    
  - script: 'xcode-select -p'
    displayName: 'Show current xcode-select path'
    
  - script: 'sudo rm -rf /Applications/Xcode.app'
    displayName: 'Remove Xcode.app symlink due Xamarin.Mac/iOS bug'
    
#   - script: 'sudo mv /Applications/Xcode_12.app /Applications/Old_Xcode_12.app'
#     displayName: 'Rename Xcode_12.app to avoid someone using the old Xcode'
    
    ## Update this section to newer versions of Xcode (e.g 14.3)
    ## Check Xcode path on ADO here: https://github.com/actions/virtual-environments/blob/main/images/macos/macos-12-Readme.md
    
  - script: 'sudo mv /Applications/Xcode_14.2.app /Applications/Xcode.app'
    displayName: 'Move Xcode.app Xcode_14.2 to /Applications/Xcode.app'
    
  - script: 'sudo xcode-select -s /Applications/Xcode.app/Contents/Developer'
    displayName: 'Ensure xcode-select point to /Applications/Xcode.app'
    
  - script: '/usr/bin/xcodebuild -version'
    displayName: 'Show Xcode Version'
    
  - script: 'xcode-select -p'
    displayName: 'Show current xcode-select path'
   
  - script: 'cat /Users/runner/Library/Preferences/Xamarin/Settings.plist'
    displayName: 'cat /Users/runner/Library/Preferences/Xamarin/Settings.plist'
    
  - script: '/usr/libexec/PlistBuddy -c "Set :AppleSdkRoot /Applications/Xcode.app" /Users/runner/Library/Preferences/Xamarin/Settings.plist'
    displayName: 'Set Preferences/Xamarin/Settings'
  
  - script: 'cat /Users/runner/Library/Preferences/Xamarin/Settings.plist'
    displayName: 'cat /Users/runner/Library/Preferences/Xamarin/Settings.plist'
    
  - task: InstallAppleCertificate@2
    inputs:
      certSecureFile: 'Distribution.p12'
      certPwd: '$(CertificatePwd)'
      keychain: 'temp'
  
  - task: InstallAppleCertificate@2
    inputs:
      certSecureFile: 'DeveloperIDApplication.p12'
      certPwd: '$(CertificatePwd)'
      keychain: 'temp'

  - task: InstallAppleCertificate@2
    inputs:
      certSecureFile: 'Development.p12'
      certPwd: '$(CertificatePwd)'
      keychain: 'temp'
      
  - task: InstallAppleCertificate@2
    inputs:
      certSecureFile: 'MacInstallerDistribution.p12'
      certPwd: '$(CertificatePwd)'
      keychain: 'temp'

  - task: InstallAppleProvisioningProfile@1
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: 'AppStore.mobileprovision'

  - task: InstallAppleProvisioningProfile@1
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: 'Development.mobileprovision'

  - task: InstallAppleProvisioningProfile@1
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: 'MacAppStore.provisionprofile'

  - task: InstallAppleProvisioningProfile@1
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: 'tvOS_Development.mobileprovision'

  - task: InstallAppleProvisioningProfile@1
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: 'tvOSAppStore.mobileprovision'
      
  - task: JavaToolInstaller@0
    displayName: install JDK 11
    inputs:
      versionSpec: '11'
      jdkArchitectureOption: 'x64'
      jdkSourceOption: 'PreInstalled'
      
  # Install Mono
  - task: CmdLine@2
    displayName: 'Provisioning Mono SDK'
    inputs:
      script: 'cd ~;
              curl -OL https://download.mono-project.com/archive/6.12.0/macos-10-universal/MonoFramework-MDK-6.12.0.190.macos10.xamarin.universal.pkg;
              sudo installer -pkg ~/MonoFramework-MDK-6.12.0.190.macos10.xamarin.universal.pkg -target /'

  # Azure DevOps hosted pool is still using an old version of Xamarin.iOS, 
  # so we will upgrade
  - task: CmdLine@2
    displayName: 'Provisioning Xamarin.iOS'
    inputs:
      script: 'cd ~;
              curl -OL https://download.visualstudio.microsoft.com/download/pr/c4485415-0f6b-4405-90aa-bfb47829ab64/0709daa48ae62eafabfbf980ca8b81b0/xamarin.ios-16.2.0.2.pkg;
              sudo installer -pkg ~/xamarin.ios-16.2.0.2.pkg -target /'

  - task: CmdLine@2
    displayName: 'Provisioning Xamarin.Mac'
    inputs:
      script: 'cd ~;
              curl -OL https://download.visualstudio.microsoft.com/download/pr/c4485415-0f6b-4405-90aa-bfb47829ab64/264a5ee1ce10bee052a88adb09b049d8/xamarin.mac-9.1.0.2.pkg;
              sudo installer -pkg ~/xamarin.mac-9.1.0.2.pkg -target /'

  - task: CmdLine@2
    displayName: 'Provisioning Xamarin.Android'
    inputs:
      script: 'cd ~;
              curl -OL https://dl.internalx.com/vsts-devdiv/Xamarin.Android/public/7087595/d17-5/797e2e13d1706ace607da43703769c5a55c4de60/xamarin.android-13.2.0.0.pkg;
              sudo installer -pkg ~/xamarin.android-13.2.0.0.pkg -target /'

  # Install GitVersion
  - script: curl -OL https://github.com/GitTools/GitVersion/releases/download/5.11.1/gitversion-osx-x64-5.11.1.tar.gz &&
            tar -xvf gitversion-osx-x64-5.11.1.tar.gz &&
            mv gitversion /usr/local/bin
    displayName: 'Install GitVersion 5.11.1'

  # Print the current version of Xamarin.iOS
  - task: CmdLine@2
    displayName: 'Show Xamarin.iOS Version'
    inputs:
      script: '/Library/Frameworks/Xamarin.iOS.framework/Versions/Current/bin/mtouch --version'
  
  - script: 'dotnet workload install android ios macos tvos maccatalyst'
    displayName: 'Install .NET 7.0 Android/iOS/macOS/tvOS/MacCatalyst'

  - script: 'sudo dotnet workload update'
    displayName: 'Update .NET 7.0 workloads'

  - task: PowerShell@2
    displayName: "Patch Microsoft.macOS.dll with 12.3.300"
    inputs:
      targetType: 'inline'
      script: |
        # Force .NET workload to reference old Microsoft.macOS/iOS.dll so it can be used by people trying to mix old version of worload.

        & mkdir -p Microsoft.macOS/ 
        & mkdir -p Microsoft.iOS/

        curl -o Microsoft.macOS/Microsoft.macOS.Ref.zip -L https://www.nuget.org/api/v2/package/Microsoft.macOS.Ref/12.3.303
        curl -o Microsoft.iOS/Microsoft.iOS.Ref.zip -L https://www.nuget.org/api/v2/package/Microsoft.iOS.Ref/15.4.303

        unzip -d ./Microsoft.iOS Microsoft.iOS/Microsoft.iOS.Ref.zip
        unzip -d ./Microsoft.macOS Microsoft.macOS/Microsoft.macOS.Ref.zip

        function Copy-Ref-Assembly($path, $net, $platform)
        {
            foreach($version in Get-ChildItem -Path $path -Directory -Name)
            {
                $file = $path+$version+"/ref/$net/Microsoft.$platform.dll"
                if (-not (Test-Path -Path $file -PathType Leaf) -or $version.Contains("preview"))
                {
                    continue
                }
                $old = $file + ".old"
                if (Test-Path -Path $old -PathType Leaf)
                {
                    rm $old
                }
                mv $file $old 
                cp ./Microsoft.$platform/ref/$net/Microsoft.$platform.dll $file
                Write-Output "Patching file: $file"
            }
        }
        
        dotnet new macos -o mac_project
        dotnet new ios -o ios_project
        
        (Get-Content -path ./mac_project/mac_project.csproj -Raw) -replace 'net7.0-macos','net6.0-macos' | Set-Content -Path ./mac_project/mac_project.csproj
        (Get-Content -path ./ios_project/ios_project.csproj -Raw) -replace 'net7.0-ios','net6.0-ios' | Set-Content -Path ./ios_project/ios_project.csproj

        dotnet build ./mac_project
        dotnet build ./ios_project

        $path = "~/.nuget/packages/microsoft.macos.ref/"
        Copy-Ref-Assembly $path "net6.0" "macOS"

        $path = "~/.nuget/packages/microsoft.ios.ref/"
        Copy-Ref-Assembly $path "net6.0" "iOS"

