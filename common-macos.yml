  steps:
  
  - script: '/usr/bin/xcodebuild -version'
    displayName: 'Show Xcode Version' 
    
  - script: 'xcode-select -p'
    displayName: 'Show current xcode-select path'
    
  - script: 'sudo rm -rf /Applications/Xcode.app'
    displayName: 'Remove Xcode.app symlink due Xamarin.Mac/iOS bug'
    
  - script: 'sudo mv /Applications/Xcode_12.app /Applications/Old_Xcode_12.app'
    displayName: 'Rename Xcode_12.app to avoid someone using the old Xcode'
    
    ## Update this section to newer versions of Xcode (e.g 12.4)
  - script: 'sudo mv /Applications/Xcode_12.3.app /Applications/Xcode.app'
    displayName: 'Move Xcode.app 12.3 to /Applications/Xcode.app'
    
  - script: 'sudo xcode-select -s /Applications/Xcode.app/Contents/Developer'
    displayName: 'Ensure xcode-select point to /Applications/Xcode.app'
    
  - script: '/usr/bin/xcodebuild -version'
    displayName: 'Show Xcode Version'
    
  - script: 'xcode-select -p'
    displayName: 'Show current xcode-select path'
   
  - script: 'cat /Users/runner/Library/Preferences/Xamarin/Settings.plist'
    displayName: 'cat /Users/runner/Library/Preferences/Xamarin/Settings.plist'
    
  - script: '/usr/libexec/PlistBuddy -c "Set :AppleSdkRoot /Applications/Xcode.app" /Users/runner/Library/Preferences/Xamarin/Settings.plist'
    displayName: 'Set Preferences/Xamarin/Settings'
  
  - script: 'cat /Users/runner/Library/Preferences/Xamarin/Settings.plist'
    displayName: 'cat /Users/runner/Library/Preferences/Xamarin/Settings.plist'
    
  - task: InstallAppleCertificate@2
    inputs:
      certSecureFile: 'Dev.p12'
      certPwd: '$(DevCertPwd)'
      keychain: 'temp'
      
  - task: InstallAppleCertificate@2
    inputs:
      certSecureFile: 'Deploy.p12'
      certPwd: '$(DeployCertPwd)'
      keychain: 'temp'

  - task: InstallAppleProvisioningProfile@1
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: '0d6fe3df-fb0c-48eb-af91-9321c09913cd.mobileprovision'

  - task: InstallAppleProvisioningProfile@1
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: '8a51b462-c8e1-4cc7-bc2e-6f68ba6631b7.mobileprovision'

  - task: InstallAppleProvisioningProfile@1
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: 'ca446ca9-779f-4e69-97db-5b9820baf0ae.mobileprovision'

  # Install Mono
  - task: CmdLine@2
    displayName: 'Provisioning Mono SDK'
    inputs:
      script: 'cd ~;
              curl -O https://download.visualstudio.microsoft.com/download/pr/98cec39a-ed8a-4d97-971d-48beb00aafb3/e3b4355c6b24db604c655ccdb3daf083/monoframework-mdk-6.12.0.113.macos10.xamarin.universal.pkg;
              sudo installer -pkg ~/monoframework-mdk-6.12.0.113.macos10.xamarin.universal.pkg -target /'

  # Azure DevOps hosted pool is still using an old version of Xamarin.iOS, 
  # so we will upgrade
  - task: CmdLine@2
    displayName: 'Provisioning Xamarin.iOS'
    inputs:
      script: 'cd ~;
              curl -O https://download.visualstudio.microsoft.com/download/pr/573004d1-39a9-4cf7-87b0-e0eea351cd00/4ab0eae8f20e3d59c08393aa77c8c123/xamarin.ios-14.8.0.3.pkg;
              sudo installer -pkg ~/xamarin.ios-14.8.0.3.pkg -target /'

  - task: CmdLine@2
    displayName: 'Provisioning Xamarin.Mac'
    inputs:
      script: 'cd ~;
              curl -O https://download.visualstudio.microsoft.com/download/pr/573004d1-39a9-4cf7-87b0-e0eea351cd00/b9b9a8e129dafd7cc8dc23a6d6b09185/xamarin.mac-7.2.0.3.pkg;
              sudo installer -pkg ~/xamarin.mac-7.2.0.3.pkg -target /'

  - task: CmdLine@2
    displayName: 'Provisioning Xamarin.Android'
    inputs:
      script: 'cd ~;
              curl -O https://download.visualstudio.microsoft.com/download/pr/573004d1-39a9-4cf7-87b0-e0eea351cd00/97344f8a365978fce27bffb3ec30cb92/xamarin.android-11.1.0.26.pkg;
              sudo installer -pkg ~/xamarin.android-11.1.0.26.pkg -target /'

  # Install GitVersion
  - task: CmdLine@2
    displayName: 'Install GitVersion 5.2.4'
    inputs:
      script: 'cd ~;
              mkdir gitversion;
              cd ~/gitversion;
              curl -OL https://github.com/GitTools/GitVersion/releases/download/5.6.3/gitversion-osx-x64-5.6.3.tar.gz;
              tar -xvf gitversion-osx-x64-5.6.3.tar.gz;
              sudo ln -s ~/gitversion/gitversion /usr/local/bin/gitversion'

  # Print the current version of Xamarin.iOS
  - task: CmdLine@2
    displayName: 'Show Xamarin.iOS Version'
    inputs:
      script: '/Library/Frameworks/Xamarin.iOS.framework/Versions/Current/bin/mtouch --version'
  
