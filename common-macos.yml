  steps:
  
  - script: '/usr/bin/xcodebuild -version'
    displayName: 'Show Xcode Version' 
    
  - script: 'xcode-select -p'
    displayName: 'Show current xcode-select path'
    
  - script: 'sudo rm -rf /Applications/Xcode.app'
    displayName: 'Remove Xcode.app symlink due Xamarin.Mac/iOS bug'
    
#   - script: 'sudo mv /Applications/Xcode_12.app /Applications/Old_Xcode_12.app'
#     displayName: 'Rename Xcode_12.app to avoid someone using the old Xcode'
    
    ## Update this section to newer versions of Xcode (e.g 13.1)
    ## Check Xcode path on ADO here: https://github.com/actions/virtual-environments/blob/main/images/macos/macos-11-Readme.md
  - script: 'sudo mv /Applications/Xcode_13.0.app /Applications/Xcode.app'
    displayName: 'Move Xcode.app 13.0 to /Applications/Xcode.app'
    
  - script: 'sudo xcode-select -s /Applications/Xcode.app/Contents/Developer'
    displayName: 'Ensure xcode-select point to /Applications/Xcode.app'
    
  - script: '/usr/bin/xcodebuild -version'
    displayName: 'Show Xcode Version'
    
  - script: 'xcode-select -p'
    displayName: 'Show current xcode-select path'
   
  - script: 'cat /Users/runner/Library/Preferences/Xamarin/Settings.plist'
    displayName: 'cat /Users/runner/Library/Preferences/Xamarin/Settings.plist'
    
  - script: '/usr/libexec/PlistBuddy -c "Set :AppleSdkRoot /Applications/Xcode.app" /Users/runner/Library/Preferences/Xamarin/Settings.plist'
    displayName: 'Set Preferences/Xamarin/Settings'
  
  - script: 'cat /Users/runner/Library/Preferences/Xamarin/Settings.plist'
    displayName: 'cat /Users/runner/Library/Preferences/Xamarin/Settings.plist'
    
  - task: InstallAppleCertificate@2
    inputs:
      certSecureFile: 'Dev.p12'
      certPwd: '$(DevCertPwd)'
      keychain: 'temp'
      
  - task: InstallAppleCertificate@2
    inputs:
      certSecureFile: 'Deploy.p12'
      certPwd: '$(DeployCertPwd)'
      keychain: 'temp'

  - task: InstallAppleProvisioningProfile@1
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: '3f17d20d-82dd-4ca2-ad90-661e1c8564ca.mobileprovision'

  - task: InstallAppleProvisioningProfile@1
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: '62ed4162-77d9-4931-8a97-f02218d4f204.mobileprovision'

  - task: InstallAppleProvisioningProfile@1
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: 'b424442b-e8e9-4ee8-b9bd-d11a86ec8089.provisionprofile'

  # Install Mono
  - task: CmdLine@2
    displayName: 'Provisioning Mono SDK'
    inputs:
      script: 'cd ~;
              curl -OL https://download.mono-project.com/archive/6.12.0/macos-10-universal/MonoFramework-MDK-6.12.0.158.macos10.xamarin.universal.pkg;
              sudo installer -pkg ~/MonoFramework-MDK-6.12.0.158.macos10.xamarin.universal.pkg -target /'

  # Azure DevOps hosted pool is still using an old version of Xamarin.iOS, 
  # so we will upgrade
  - task: CmdLine@2
    displayName: 'Provisioning Xamarin.iOS'
    inputs:
      script: 'cd ~;
              curl -OL https://bosstoragemirror.blob.core.windows.net/wrench/xcode13-ios/2771277e05ecbee29976a57ae0b596129fef605f/5242052/package/xamarin.ios-15.0.0.6.pkg;
              sudo installer -pkg ~/xamarin.ios-15.0.0.6.pkg -target /'

  - task: CmdLine@2
    displayName: 'Provisioning Xamarin.Mac'
    inputs:
      script: 'cd ~;
              curl -OL https://bosstoragemirror.blob.core.windows.net/wrench/d16-10/2566861a9e0495d6f3c2c303ef3924be3a9f49a7/5024030/package/xamarin.mac-7.14.0.27.pkg;
              sudo installer -pkg ~/xamarin.mac-7.14.0.27.pkg -target /'

  - task: CmdLine@2
    displayName: 'Provisioning Xamarin.Android'
    inputs:
      script: 'cd ~;
              curl -OL https://dl.internalx.com/vsts-devdiv/Xamarin.Android/public/4829460/d16-10/ae14cafda4befc69867db19eee0728efec9cf71b/xamarin.android-11.3.0.4.pkg;
              sudo installer -pkg ~/xamarin.android-11.3.0.4.pkg -target /'

  # Install GitVersion
  - script: curl -OL https://github.com/GitTools/GitVersion/releases/download/5.6.8/gitversion-osx-x64-5.6.8.tar.gz &&
            tar -xvf gitversion-osx-x64-5.6.8.tar.gz &&
            mv gitversion /usr/local/bin &&
            mv *.dylib /usr/local/bin
    displayName: 'Install GitVersion 5.8.8'

  # Print the current version of Xamarin.iOS
  - task: CmdLine@2
    displayName: 'Show Xamarin.iOS Version'
    inputs:
      script: '/Library/Frameworks/Xamarin.iOS.framework/Versions/Current/bin/mtouch --version'
  
  - script: 'dotnet workload install android ios macos tvos'
    displayName: 'Install .NET 6.0 Android iOS/macOS/tvOS'
